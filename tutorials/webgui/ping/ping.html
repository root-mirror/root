<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <title>RWebWindow latency test</title>
    <script src="jsrootsys/scripts/JSRoot.core.js" type="text/javascript"></script>
  </head>

  <body>
     <button onclick="SendMsg('halt')">Halt</button>
     <h2 id="main">Msg</h2>
     <h3 id="counter"></h3>
  </body>

  <script>

    class PingPongHandler {
       constructor() {
          this.handle = null;
          this.last_ping = 0;
          this.sum = [0, 0, 0];
       }

       setOutput(msg, id) {
          if (!id) id = "main";
          let elem = document.getElementById(id);
          if (elem) elem.innerHTML = msg;
       }

       // method called when connection established
       onWebsocketOpened(handle) {
          this.handle = handle;
          this.setOutput("Connected");
          this.sendPing();
          this.configInterval(3000);
       }

       // method with new message from server
       onWebsocketMsg(handle, msg, offset) {
          if (typeof msg != "string") {
             // let arr = new Float32Array(msg, offset);
             // AddOutput("bin: " + arr.toString());
          } else if (msg.indexOf("PING:") == 0) {
             this.processPing(msg.substr(5));
          }
       }

       // method called when connection is gone
       onWebsocketClosed(handle) {
          this.handle = null;
          this.configInterval(0);
          // when connection closed, close panel as well
          if (window) window.close();
       }

       // configure periodic handler
       configInterval(msec) {
          if (this.interval) {
             clearInterval(this.interval);
             this.interval = null;
          }
          if (!msec) return;

          this.interval = setInterval(() => {
             let tm = new Date().getTime();
             if (tm - this.last_ping > 2000)
                this.sendPing();
          }, msec);
       }

       // periodical handler
       sendPing() {
          let tm1 = new Date().getTime();
          this.last_ping = tm1;
          if (this.handle)
             this.handle.send("PING:" + tm1);
       }

       processPing(msg) {
          let tm1 = parseInt(msg);
          let tm2 = new Date().getTime();
          let diff = tm2 - tm1;

          this.sum[0]+=1;
          this.sum[1]+=diff;
          this.sum[2]+=diff*diff;

          let mean = this.sum[1] / this.sum[0], dev = "";

          if (this.sum[0] > 5) {
             dev = this.sum[2] / this.sum[0] - mean*mean;
             dev = (dev > 0) ? Math.sqrt(dev) : 0;
          }

          this.setOutput("Round-trip: " + mean.toFixed(1) + "ms " + (dev > 0 ? "&plusmn;" + dev.toFixed(0) : ""));
          this.setOutput("Cnt: " + this.sum[0], "counter");
          this.sendPing();
       }
    }

    let main_handler = new PingPongHandler();

    function SendMsg(txt) {
       if (main_handler && main_handler.handle)
          main_handler.handle.send(txt);
    }

    // important this line, which need to be specially handled
    // line MUST always end with "({" symbols
    JSROOT.connectWebWindow({
       receiver: main_handler
    });

  </script>

</html>
